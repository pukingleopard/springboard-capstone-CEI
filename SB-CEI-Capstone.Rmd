---
title: "Springboard Capstone Project - CEI"
author: "James Hamilton"
date: "March 24, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(gridExtra)
```

# The Question

What useful insights can be drawn from the clients' customer and invoice data?
    - Are some clients "over purchasing" because they don't understand the licensing scheme?
    - What market segments are the largest / smallest and which market segments are growing / shrinking?
    
# The Data
```{r load the data, echo=FALSE}
accounts = read.csv("SB-CEI-Capstone-Account.csv", header = TRUE)
orders = read.csv("SB-CEI-Capstone-Order.csv", header = TRUE)
orderlines = read.csv("SB-CEI-Capstone-Order-Product-Line.csv", header=TRUE)
```

The data was provided by the client in the form of a text CSV export from their Salesforce database.

I focused primarily on the Account, Order, and Order Line tables. Some cleanup of the data was needed - a detailing of that activity is included at the end of this report.

### Account

data included the customer name and demographic data: location, employee counts, annual revenue and various industry classifiers.

A correlation test indicates that the number of employees and Annual revenue are highly correlated (.93 at 99% confidence) across all customers indicating that using employee count alone as an indicator of the "size" of the customer would be accurate. Therefore, the following visuals are based on that conclusion and use the employee count as the primary indicator of client size.
```{r Accounts, echo=FALSE}
accounts.w <- accounts %>% filter(!is.na(accounts$Employees) & 
    accounts$Employees > 0 & 
    !is.na(accounts$Annual.Revenue) & 
    accounts$Annual.Revenue > 0)

p1 <- ggplot(data = accounts.w, aes(x = Industry)) + 
  geom_bar() +
  theme(axis.text.x = element_text(size=10, angle=35, hjust=1)) +
  ylab("Count of customers")

p2 <- ggplot(data = accounts.w, aes(Industry, Employees)) +
  geom_boxplot() +
  coord_cartesian(ylim=c(0,1000)) +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank()) +
  ylab("Employees")

grid.arrange(p2, p1)
```

Primary conclusions here are that the Machinery, Manufacturing and Construction industries represent the majority of the client base and those companies are predominately < 250 employees in size. "Other" and "Retail" are also fairly large and will be studied as well.

```{r echo=FALSE}
summary(accounts[ accounts$Industry == "Construction", ]$Employees)
summary(accounts[ accounts$Industry == "Machinery", ]$Employees)
summary(accounts[ accounts$Industry == "Manufacturing", ]$Employees)
summary(accounts[ accounts$Industry == "Other", ]$Employees)
summary(accounts[ accounts$Industry == "Retail", ]$Employees)
```

Here we see that these industries are represented by companies that are generally in the range of 0 - 269 employees. Specifically, across all industries about 87% of all clients have less than 270 employees. This does not however, describe which industries or companies are the "most valuable" in terms of dollars spent.

### Orders

data spanned two tables and included primarily dollar amounts, dates, quantities, payment methods and keys into other tables including the invoices and accounts tables. We are looking for two key pieces of information from this data:
    - The ratio of customer size to the amount of purchase made by industry. (in dollars and quantity of software licenses or seats purchased) This will be used to identify outliers.
    - The rate of change in amount of purchase made per industry
```{r Orders, echo=FALSE}
# Isolating columns needed from the three tables
working.ol <- orderlines[ , c("SalesOrder","Product","ProductFamily","ProductAmount","Quantity") ]
working.orders <- orders[ , c("Record.ID","Order.Date","Order.Type","Account.Number") ]
working.orders <- rename(working.orders, SalesOrder = Record.ID)
working.acct <- accounts[ , c("Account.Number",         "Billing.Country",
                              "Billing.State.Province", "Employees",
                              "Industry",               "Ownership")]
work.o <- left_join(working.ol, working.orders, by = "SalesOrder")
work <- left_join(work.o, working.acct, by = "Account.Number")

byindustry <- group_by(work, Industry) %>%
  summarise(median_e_count = median(Employees),
    tot_e = sum(Employees),
    median_quantity = median(Quantity),
    mean_quantity = mean(Quantity),
    max_quantity = max(Quantity),
    tot_quantity = sum(Quantity),
    median_dollars = median(ProductAmount),
    mean_dollars = mean(ProductAmount),
    max_dollars = max(ProductAmount),
    tot_dollars = sum(ProductAmount)
    )

# I chose the mean for the quantity b/c the median for all industries is 1.
byindustry$qtyratio <- byindustry$mean_quantity / byindustry$median_e_count
byindustry$dollaratio <- byindustry$median_dollars / byindustry$median_e_count

ggplot(data = byindustry, aes(x = Industry)) +
  geom_point(aes(y = dollaratio, size = qtyratio, color = tot_dollars)) +
  coord_flip()

byaccount <- filter(work, !is.na(Account.Number) & !is.na(Employees) & Employees > 0) %>%
  group_by(., Industry, Account.Number, SalesOrder, Order.Date, Employees) %>%
  summarise(., 
    total_order_quantity = sum(Quantity),
    total_order_dollars = sum(ProductAmount)
  ) %>%
  arrange(., Order.Date)
byaccount$qty_per_emp <- byaccount$total_order_quantity / byaccount$Employees
byaccount$dol_per_emp <- byaccount$total_order_dollars / byaccount$Employees

ggplot(byaccount, aes(x = Order.Date)) +
  geom_point(aes(y = qty_per_emp, color = dol_per_emp)) +
  facet_wrap(~ Industry) + 
  theme(axis.text.x = element_blank()) +
  xlab("Date")
```

It is important to note that about 1300 orders were removed from this analysis due to missing important column info - primarily Employee count.

Looking at these plots it appears that none of the Industries represented have a large group of purchases that are above the overall median of 1. This should be good news because that would suggest that the majority of clients have not overbought.

However, the display is fairly crowded and doesn't include the baseline value per industry so I'll focus on those industry groupings that appear to have the largest number of clients / orders and show a plot for each. Specifically: Chemicals, Construction, Consulting, Engineering, Machinery, Manufacturing, Other, Retail, Transportation, and Utilities.

```{r Industry Specific, echo = FALSE}

```

